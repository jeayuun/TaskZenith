{% extends "index.html" %}

{% block title %}
    Tasks
{% endblock %}

{% block right_top_title %}
    Tasks
{% endblock %}

{% block content %}
    <div class="logo">
        <h2>
            <img src="https://99gifshop.neocities.org/items/11/tulips_blue_lg_clr.gif" title="TaskZenith" width="30%">
            TaskZenith
        </h2>
        <div class="close">
            <span class="material-symbols-outlined">close</span>
        </div>
    </div>
    <nav>
        <ul>
            <li><a href="/" id="dashboard-link"><span class="material-symbols-outlined">dashboard</span><span class="title">Dashboard</span></a></li>
            <li><a href="/tasks" id="tasks-link" class="fill"><span class="material-symbols-outlined full">check_box</span><span class="title-full">Tasks</span></a></li>
            <li><a href="/goals" id="goals-link"><span class="material-symbols-outlined">flag</span><span class="title">Goals</span></a></li>
            <li><a href="/schedule" id="schedule-link"><span class="material-symbols-outlined">calendar_month</span><span class="title">Schedule</span></a></li>
            <li><a href="/projects" id="projects-link"><span class="material-symbols-outlined">inventory_2</span><span class="title">Projects</span></a></li>
            <li><a href="/profile" id="profile-link"><span class="material-symbols-outlined">group</span><span class="title">My Profile</span></a></li>
        </ul>
    </nav>
{% endblock %}

{% block additional_content %}
<!-- Tasks: To Do start -->
<form autocomplete="off" id="taskForm">
    <!-- user will input the task here -->
    <div class="inputBox">
        <input type="text" placeholder="Enter a task" id="userInput">
        <button type="submit">Add to list</button>
    </div>
</form>
<div class="tasksContainer">
    <section id="container" class="tasksContainer">
        <section>
            <h2 class="toDo">To Do</h2>
            <ul class="tasksSection" id="toDo" ondrop="drop(event)" ondragover="allowDrop(event)"></ul>
        </section>
        <section>
            <h2 class="inProgress">In Progress</h2>
            <ul class="tasksSection" id="inProgress" ondrop="drop(event)" ondragover="allowDrop(event)"></ul>
        </section>
        <section>
            <h2 class="inReview">In Review</h2>
            <ul class="tasksSection" id="inReview" ondrop="drop(event)" ondragover="allowDrop(event)"></ul>
        </section>
        <section>
            <h2 class="completed">Completed</h2>
            <ul class="tasksSection" id="completed" ondrop="drop(event)" ondragover="allowDrop(event)"></ul>
        </section>
    </section>
</div>
<!-- Tasks: To Do end -->

<!-- descriptions for each task -->
<section id="descrpContainer">
    <section id="descrpWrapper">
        <textarea id="description" placeholder="Enter your notes about this task"></textarea>
        <button id="cancel">Cancel</button>
        <button id="save">Save Changes</button>
    </section>
</section>

<script>
    var storage = [];
    var liId = 0;
    var spanId = 0;
    var noteBtnClicked = 0;

    // Self-invoked function to get elements from local storage
    (function () {
        if (getItemOnLocalStorage('tasks')) {
            var parsed = JSON.parse(getItemOnLocalStorage('tasks'));
            var max = 0;
            for (var i = 0; i < parsed.length; i++) {
                createElement(parsed[i]);
                if (parsed[i].id > max) {
                    max = parsed[i].id;
                }
            }
            storage = parsed;
            liId = max;
            spanId = max * -1;
        }
    })();

    // Sections events
    var domSections = document.getElementsByClassName('tasksSection');
    for (var i = 0; i < domSections.length; i++) {
        addEventsTosection(domSections[i]);
    }

    function addEventsTosection(section) {
        section.addEventListener('dragover', function (event) {
            event.preventDefault();
        });
        section.addEventListener('drop', function (event) {
            var taskId = event.dataTransfer.getData('text');
            var taskElement = document.getElementById(taskId);
            if (event.target.className.includes('tasksSection')) {
                event.target.appendChild(taskElement);
                var liSpanId = parseInt(taskId) * -1 + '';
                var elementObj = {
                    id: parseInt(taskId),
                    value: document.getElementById(liSpanId).innerText,
                    parent: event.target.id
                };
                storage.find(function (storageItem) {
                    return storageItem.id === elementObj.id;
                }).parent = event.target.id;
                setItemOnLocalStorage('tasks', JSON.stringify(storage));
            }
        });
    }

    // Submit btn function
    document.getElementById('taskForm').addEventListener('submit', function (e) {
        e.preventDefault(); // Prevent form submission
        var userInput = document.getElementById('userInput').value;
        if (userInput) {
            var objData = {
                id: ++liId,
                value: userInput,
                parent: 'toDo'
            };
            createElement(objData);
            setItemOnLocalStorage('tasks', JSON.stringify(storage));
            document.getElementById('userInput').value = ''; // Clear the input field
        } else {
            alert('There is no data to be added');
        }
    });

    // Functions to create a new element (task)
    function createElement(objData) {
        console.log('Creating element:', objData); // Debugging
        var obj = {
            id: objData.id,
            value: objData.value,
            parent: objData.parent
        };
        var list = document.createElement('li');
        document.getElementById(obj.parent).appendChild(list);
        createListChildren(list, objData);
        list.id = objData.id;
        list.setAttribute('draggable', true);
        list.addEventListener('dragstart', function (event) {
            event.dataTransfer.setData('text', event.target.id);
        });
        storage.push(obj);
    }

    function createListChildren(list, objData) {
        // Create task structure based on provided HTML
        var taskCard = document.createElement('div');
        taskCard.className = 'tasksCard';
        taskCard.draggable = true;

        var tasksProgress = document.createElement('div');
        tasksProgress.className = 'tasksProgress';
        var process = document.createElement('div');
        process.innerHTML = '<h2>In Progress</h2>';
        var priority = document.createElement('div');
        priority.innerHTML = '<h2>High Priority</h2>';
        tasksProgress.appendChild(process);
        tasksProgress.appendChild(priority);

        var tasksTop = document.createElement('div');
        tasksTop.className = 'tasksTop';
        tasksTop.innerHTML = `<h2>${objData.value}<br></h2>`;

        var tasks = document.createElement('div');
        tasks.innerHTML = '<h2>Due: 7 July 2024</h2>';

        taskCard.appendChild(tasksProgress);
        taskCard.appendChild(tasksTop);
        taskCard.appendChild(tasks);

        list.appendChild(taskCard);
    }

    // Functions to set and get elements from local storage
    function setItemOnLocalStorage(key, value) {
        localStorage.setItem(key, value);
    }

    function getItemOnLocalStorage(key) {
        return localStorage.getItem(key);
    }

    // Note and delete functions
    function handleIconClick(e) {
        var uList = document.getElementById(e.target.id).parentElement.nextSibling;
        if (e.target.className == 'fas fa-angle-down') {
            e.target.className = 'fas fa-angle-up';
            uList.style.display = 'block';
            uList.style.zIndex = '1';
        } else {
            e.target.className = 'fas fa-angle-down';
            uList.style.display = 'none';
            uList.style.zIndex = '0';
        }
    }

    function handleNoteBtnClick(e) {
        // Close the ul of buttons
        var icon = e.target.parentElement.parentElement.children[0].children[1];
        icon.className = 'fas fa-angle-down';
        var uList = e.target.parentElement;
        uList.style.display = 'none';
        uList.style.zIndex = '0';

        // Save which element clicked
        noteBtnClicked = e.target.parentElement.parentElement.id;

        // If this element has previous note --> display it
        for (var i = 0; i < storage.length; i++) {
            if (storage[i].id == noteBtnClicked && storage[i].note) {
                document.getElementById('description').value = storage[i].note;
            }
        }

        // Make note section appear and be stable after that
        document.getElementById('descrpContainer').style.animationName = 'show';
        setTimeout(function () {
            document.getElementById('descrpContainer').style.maxHeight = '90vh';
        }, 1800);

        // Give the background grey overlay
        document.getElementsByTagName('main')[0].className = 'mainAfter';
    }

    function handleDeleteBtnClick(e) {
        var confirmation = confirm('Do you want to delete this task?');
        if (confirmation) {
            var targetId = e.target.parentElement.parentElement.id;
            var newStorage = [];

            // Delete from storage array
            for (var i = 0; i < storage.length; i++) {
                if (storage[i].id != targetId) {
                    newStorage.push(storage[i]);
                }
            }
            storage = newStorage;
            // Delete from local storage
            setItemOnLocalStorage('tasks', JSON.stringify(storage));

            // Delete from DOM tree
            document.getElementById(targetId).remove();
        }
    }

    // Save and cancel buttons listeners
    document.getElementById('cancel').addEventListener('click', cancelNoteHandler);
    document.getElementById('save').addEventListener('click', saveNoteHandler);

    function cancelNoteHandler() {
        // Empty the note text area
        setTimeout(function () {
            document.getElementById('description').value = '';
        }, 2000);

        // Make note section disappear
        document.getElementById('descrpContainer').style.animationName = 'hide';
        setTimeout(function () {
            document.getElementById('descrpContainer').style.maxHeight = '0';
        }, 1800);

        // Remove the background grey overlay
        document.getElementsByTagName('main')[0].className = '';
    }

    function saveNoteHandler() {
        for (var i = 0; i < storage.length; i++) {
            if (storage[i].id == noteBtnClicked) {
                storage[i].note = document.getElementById('description').value;
            }
        }
        setItemOnLocalStorage('tasks', JSON.stringify(storage));

        // Empty the note text area and close it
        cancelNoteHandler();
    }

    // Event delegation for dynamically added note and delete buttons
    document.addEventListener('click', function (event) {
        if (event.target.classList.contains('noteBtn')) {
            handleNoteBtnClick(event);
        }
        if (event.target.classList.contains('deleteBtn')) {
            handleDeleteBtnClick(event);
        }
    });

    // Drag and drop functions
    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event) {
        event.dataTransfer.setData('text', event.target.id);
    }

    function drop(event) {
        event.preventDefault();
        var taskId = event.dataTransfer.getData('text');
        var taskElement = document.getElementById(taskId);
        if (event.target.className.includes('tasksSection')) {
            event.target.appendChild(taskElement);
            var liSpanId = parseInt(taskId) * -1 + '';
            var elementObj = {
                id: parseInt(taskId),
                value: document.getElementById(liSpanId).innerText,
                parent: event.target.id
            };
            storage.find(function (storageItem) {
                return storageItem.id === elementObj.id;
            }).parent = event.target.id;
            setItemOnLocalStorage('tasks', JSON.stringify(storage));
        }
    }
</script>

{% endblock %}
